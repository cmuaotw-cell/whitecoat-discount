<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>白袍之友專屬折扣碼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden; /* 不捲動 */
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
    }
    .wrap {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px 20px 20px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      max-width: 360px;
      width: 90%;
      text-align: center;
    }
    .title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 16px;
    }
    .code {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 2px;
      padding: 12px 16px;
      border-radius: 12px;
      background: #f0f4ff;
      display: inline-block;
      margin-bottom: 12px;
    }
    .status {
      font-size: 13px;
      color: #888;
      margin-bottom: 4px;
    }
    .note {
      font-size: 12px;
      color: #999;
    }
    .spinner {
      border: 4px solid #eee;
      border-top: 4px solid #4c6fff;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .error {
      color: #c00;
      font-size: 14px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- 載入中 -->
      <div id="loading">
        <div class="spinner"></div>
        <div class="subtitle">正在為您領取專屬折扣碼…</div>
      </div>

      <!-- 結果 -->
      <div id="result" style="display:none;">
        <div class="title">白袍之友專屬折扣碼</div>
        <div class="subtitle" id="subtitle"></div>
        <div class="code" id="code"></div>
        <div class="status" id="statusText"></div>
        <div class="note">
          每台裝置限領一次，請截圖或記下此折扣碼。
        </div>
      </div>

      <!-- 錯誤 -->
      <div id="error" style="display:none;">
        <div class="title">暫時無法領取折扣碼</div>
        <div class="error" id="errorText"></div>
        <div class="note">
          若持續發生，請洽現場工作人員或主辦單位協助。
        </div>
      </div>
    </div>
  </div>

  <script>
    // 1) 產生 / 取得裝置 ID（存在 localStorage）
    function getOrCreateDeviceId() {
      const key = 'whitecoat_device_id_v1';
      try {
        let id = localStorage.getItem(key);
        if (!id) {
          id = 'dev-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
          localStorage.setItem(key, id);
        }
        return id;
      } catch (e) {
        // 如果 localStorage 被關閉，就每次給新的（後端仍會防止重複）
        return 'dev-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
      }
    }

    // 2) JSONP callback：Apps Script 會呼叫這個函式
    function handleClaim(res) {
      document.getElementById('loading').style.display = 'none';

      if (!res || res.status === 'empty') {
        document.getElementById('error').style.display = 'block';
        document.getElementById('errorText').textContent =
          '折扣碼已全數發放完畢，感謝您的熱情支持。';
        return;
      }

      if (res.status === 'error') {
        document.getElementById('error').style.display = 'block';
        document.getElementById('errorText').textContent = '系統錯誤：' + res.message;
        return;
      }

      if (res.status !== 'ok') {
        document.getElementById('error').style.display = 'block';
        document.getElementById('errorText').textContent =
          '系統發生未知錯誤，請稍後再試。';
        return;
      }

      document.getElementById('result').style.display = 'block';
      document.getElementById('code').textContent = res.code;
      document.getElementById('subtitle').textContent =
        '感謝您支持台灣白袍管樂團與公益活動。';
      document.getElementById('statusText').textContent =
        res.reused
          ? ('您先前已領取過折扣碼，這是您的專屬代碼（第 ' + res.index + ' 位）。')
          : ('您是第 ' + res.index + ' 位領取折扣碼的朋友！');
    }

    // 3) 透過 JSONP 向 Apps Script 要折扣碼
    function requestCode() {
      const deviceId = encodeURIComponent(getOrCreateDeviceId());
      const BASE_URL = 'https://script.google.com/macros/s/AKfycbxfhZna8hVNU9XWHv0pom_aKEIHX6eAc3Gf4qigMPIaPNMupgkoKX4XBaE6kSRKxgfw/exec';
      const joinChar = BASE_URL.includes('?') ? '&' : '?';

      const script = document.createElement('script');
      script.src =
        BASE_URL +
        joinChar +
        'action=claim&deviceId=' + deviceId +
        '&callback=handleClaim';

      script.onerror = function() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('errorText').textContent =
          '無法連線至伺服器，請稍後再試。';
      };

      document.body.appendChild(script);
    }

    window.addEventListener('load', requestCode);
  </script>
</body>
</html>

